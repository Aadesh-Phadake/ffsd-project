<%- layout('./layouts/boilerplate') %>

<link rel="stylesheet" href="/css/admin.css">

<div class="admin-wrapper">
  <!-- Sidebar -->
  <div class="admin-sidebar" id="adminSidebar">
    <div class="sidebar-header">
      <h3><i class="fas fa-tachometer-alt me-2"></i>Admin Panel</h3>
    </div>
    <nav class="sidebar-nav">
      <div class="nav-item">
        <a href="/admin" class="nav-link" data-page="dashboard">
          <i class="fas fa-chart-pie"></i>
          <span>Dashboard</span>
        </a>
      </div>
      <div class="nav-item">
        <a href="/admin/hotels" class="nav-link" data-page="hotels">
          <i class="fas fa-hotel"></i>
          <span>Hotel Management</span>
        </a>
      </div>
      <div class="nav-item">
        <a href="/admin/users" class="nav-link active" data-page="users">
          <i class="fas fa-users"></i>
          <span>User Management</span>
        </a>
      </div>
      <div class="nav-item">
        <a href="/admin/messages" class="nav-link" data-page="messages">
          <i class="fas fa-envelope"></i>
          <span>Messages</span>
        </a>
      </div>
      <div class="nav-item">
        <a href="/listings" class="nav-link">
          <i class="fas fa-home"></i>
          <span>Back to Home</span>
        </a>
      </div>
      <div class="nav-item" style="margin-top: 2rem; border-top: 1px solid rgba(255,255,255,0.1); padding-top: 1rem;">
        <a href="/logout" class="nav-link">
          <i class="fas fa-sign-out-alt"></i>
          <span>Logout</span>
        </a>
      </div>
    </nav>
  </div>

  <!-- Main Content -->
  <div class="admin-content" id="adminContent">
    <div class="admin-page py-4">
      <div class="admin-header d-flex align-items-center justify-content-between mb-4">
        <div>
          <h1 class="h3 mb-1">User Management</h1>
          <p class="text-muted mb-0">Manage registered users and their activities</p>
        </div>
        <div class="d-flex gap-2">
          <span class="badge bg-primary"><%= users.length %> Users</span>
        </div>
      </div>

      <div class="management-table">
        <div class="table-responsive">
          <table class="table mb-0 align-middle">
            <thead>
              <tr>
                <th scope="col">User</th>
                <th scope="col">Email</th>
                <th scope="col">Joined</th>
                <th scope="col">Bookings</th>
                <th scope="col">Total Spent</th>
                <th scope="col">Last Booking</th>
                <th scope="col">Status</th>
                <th scope="col">Actions</th>
              </tr>
            </thead>
            <tbody>
              <% if (users && users.length > 0) { %>
                <% users.forEach(user => { %>
                  <tr>
                    <td>
                      <div>
                        <div class="fw-semibold"><%= user.username %></div>
                        <small class="text-muted">ID: <%= user._id.toString().slice(-6) %></small>
                      </div>
                    </td>
                    <td>
                      <div class="fw-medium"><%= user.email %></div>
                    </td>
                    <td>
                      <div><%= user.createdAt ? user.createdAt.toLocaleDateString('en-GB') : 'N/A' %></div>
                      <small class="text-muted">
                        <% if (user.createdAt) { %>
                          <%= Math.floor((Date.now() - new Date(user.createdAt)) / (1000 * 60 * 60 * 24)) %> days ago
                        <% } %>
                      </small>
                    </td>
                    <td>
                      <span class="badge bg-info"><%= user.totalBookings %></span>
                    </td>
                    <td class="fw-semibold text-success">₹<%= user.totalSpent.toFixed(2) %></td>
                    <td>
                      <% if (user.lastBooking) { %>
                        <div><%= user.lastBooking.toLocaleDateString('en-GB') %></div>
                        <small class="text-muted">
                          <%= Math.floor((Date.now() - new Date(user.lastBooking)) / (1000 * 60 * 60 * 24)) %> days ago
                        </small>
                      <% } else { %>
                        <span class="text-muted">Never</span>
                      <% } %>
                    </td>
                    <td>
                      <% if (user.totalBookings > 0) { %>
                        <% let daysSinceLastBooking = user.lastBooking ? Math.floor((Date.now() - new Date(user.lastBooking)) / (1000 * 60 * 60 * 24)) : 999 %>
                        <% if (daysSinceLastBooking < 30) { %>
                          <span class="badge bg-success">Active</span>
                        <% } else if (daysSinceLastBooking < 90) { %>
                          <span class="badge bg-warning text-dark">Inactive</span>
                        <% } else { %>
                          <span class="badge bg-danger">Dormant</span>
                        <% } %>
                      <% } else { %>
                        <span class="badge bg-secondary">New User</span>
                      <% } %>
                    </td>
                    <td>
                      <div class="action-buttons">
                        <button class="btn btn-view btn-action" 
                                onclick="viewUser('<%= user._id %>', '<%= user.username %>', '<%= user.email %>', '<%= user.totalBookings %>', '<%= user.totalSpent.toFixed(2) %>')">
                          <i class="fas fa-eye"></i>
                        </button>
                        <form method="POST" action="/admin/users/<%= user._id %>?_method=DELETE" style="display: inline;">
                          <button type="submit" class="btn btn-delete btn-action" 
                                  onclick="return confirm('Are you sure you want to delete this user? This will also delete all their bookings.')">
                            <i class="fas fa-trash"></i>
                          </button>
                        </form>
                      </div>
                    </td>
                  </tr>
                <% }) %>
              <% } else { %>
                <tr>
                  <td colspan="8" class="text-center text-muted py-4">
                    <i class="fas fa-users fa-3x mb-3 d-block text-muted opacity-50"></i>
                    <h5>No users found</h5>
                    <p>There are no registered users in the system yet.</p>
                  </td>
                </tr>
              <% } %>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- User Details Modal -->
<div class="modal fade" id="userModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">User Details</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <div class="row">
          <div class="col-md-6">
            <strong>Username:</strong>
            <p id="modalUsername"></p>
          </div>
          <div class="col-md-6">
            <strong>Email:</strong>
            <p id="modalEmail"></p>
          </div>
          <div class="col-md-6">
            <strong>Total Bookings:</strong>
            <p id="modalBookings"></p>
          </div>
          <div class="col-md-6">
            <strong>Total Spent:</strong>
            <p id="modalSpent"></p>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>

<script>
  // Admin users page is ready

  function viewUser(id, username, email, bookings, spent) {
    document.getElementById('modalUsername').textContent = username;
    document.getElementById('modalEmail').textContent = email;
    document.getElementById('modalBookings').textContent = bookings;
    document.getElementById('modalSpent').textContent = '₹' + spent;
    
    const modal = new bootstrap.Modal(document.getElementById('userModal'));
    modal.show();
  }
</script>