<% layout('./layouts/boilerplate') %>
<div class="container mt-5">
    <div class="row">
        <div class="col-md-8 offset-md-2">
            <div class="card shadow-sm">
                <div class="card-body">
                    <h3 class="card-title mb-4">My Profile</h3>
                    <div class="user-info mb-4">
                        <h5>User Information</h5>
                        <div class="row">
                            <div class="col-md-6">
                                <p><strong>Username:</strong> <span id="username"><%= currentUser.username %></span></p>
                                <p><strong>Email:</strong> <span id="email"><%= currentUser.email %></span></p>
                            </div>
                            <div class="col-md-6">
                                <button class="btn btn-primary" onclick="editProfile()">Edit Profile</button>
                                <button class="btn btn-info" onclick="refreshBookings()">Refresh Bookings</button>
                                <button class="btn btn-success" onclick="downloadBookingHistory()">Download History</button>
                            </div>
                        </div>
                    </div>

                    <div class="bookings mt-4">
                        <h5>My Bookings</h5>
                        <% if (bookings && bookings.length > 0) { %>
                            <% bookings.forEach(booking => { %>
                                <div class="card mb-3">
                                    <div class="card-body">
                                        <h5 class="card-title"><%= booking.listing.title %></h5>
                                        <div class="booking-details">
                                            <p><strong>Check-in:</strong> <%= booking.checkIn %></p>
                                            <p><strong>Check-out:</strong> <%= booking.checkOut %></p>
                                            <p><strong>Guests:</strong> <%= booking.guests %></p>
                                            <p><strong>Total Amount:</strong> ₹<%= booking.totalAmount.toLocaleString("en-IN") %></p>
                                            <p><strong>Status:</strong> <span class="badge bg-success">Confirmed</span></p>
                                        </div>
                                        <a href="/listings/<%= booking.listing._id %>" class="btn btn-sm add-btn">View Property</a>
                                        <button class="btn btn-sm btn-danger" onclick="cancelBooking('<%= booking._id %>')">Cancel Booking</button>
                                    </div>
                                </div>
                            <% }) %>
                        <% } else { %>
                            <div class="alert alert-info">
                                You haven't made any bookings yet. <a href="/listings">Browse properties</a> to make your first booking!
                            </div>
                        <% } %>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Edit Profile Modal -->
<div class="modal fade" id="editProfileModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Edit Profile</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="editProfileForm">
                    <div class="mb-3">
                        <label for="editUsername" class="form-label">Username</label>
                        <input type="text" class="form-control" id="editUsername" required>
                    </div>
                    <div class="mb-3">
                        <label for="editEmail" class="form-label">Email</label>
                        <input type="email" class="form-control" id="editEmail" required>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="updateProfile()">Save Changes</button>
            </div>
        </div>
    </div>
</div>

<script>
    // User Profile AJAX Functions
    function editProfile() {
        // Populate modal with current data
        document.getElementById('editUsername').value = document.getElementById('username').textContent;
        document.getElementById('editEmail').value = document.getElementById('email').textContent;
        
        // Show modal
        const modal = new bootstrap.Modal(document.getElementById('editProfileModal'));
        modal.show();
    }

    function updateProfile() {
        const username = document.getElementById('editUsername').value;
        const email = document.getElementById('editEmail').value;
        
        fetch('/profile/update', {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ username, email })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Update UI without page reload
                document.getElementById('username').textContent = username;
                document.getElementById('email').textContent = email;
                
                // Hide modal
                const modal = bootstrap.Modal.getInstance(document.getElementById('editProfileModal'));
                modal.hide();
                
                alert('Profile updated successfully!');
            } else {
                alert('Error updating profile: ' + data.message);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error updating profile');
        });
    }

    function refreshBookings() {
        const loadingSpinner = document.createElement('div');
        loadingSpinner.innerHTML = '<div class="spinner-border" role="status"><span class="visually-hidden">Loading...</span></div>';
        loadingSpinner.className = 'text-center my-3';
        
        const bookingsContainer = document.querySelector('.bookings');
        bookingsContainer.appendChild(loadingSpinner);
        
        fetch('/profile/bookings/refresh')
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    updateBookingsDisplay(data.bookings);
                    alert('Bookings refreshed successfully!');
                } else {
                    alert('Error refreshing bookings: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error refreshing bookings');
            })
            .finally(() => {
                loadingSpinner.remove();
            });
    }

    function cancelBooking(bookingId) {
        if (confirm('Are you sure you want to cancel this booking? This action cannot be undone.')) {
            fetch(`/profile/cancel/${bookingId}`, {
                method: 'DELETE',
                headers: {
                    'Content-Type': 'application/json',
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('Booking cancelled successfully!');
                    location.reload();
                } else {
                    alert('Error cancelling booking: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error cancelling booking');
            });
        }
    }

    function downloadBookingHistory() {
        fetch('/profile/bookings/export')
            .then(response => response.blob())
            .then(blob => {
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'my-booking-history.csv';
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error downloading booking history');
            });
    }

    function updateBookingsDisplay(bookings) {
        const bookingsContainer = document.querySelector('.bookings');
        if (bookings.length === 0) {
            bookingsContainer.innerHTML = `
                <h5>My Bookings</h5>
                <div class="alert alert-info">
                    You haven't made any bookings yet. <a href="/listings">Browse properties</a> to make your first booking!
                </div>
            `;
        } else {
            let bookingsHTML = '<h5>My Bookings</h5>';
            bookings.forEach(booking => {
                bookingsHTML += `
                    <div class="card mb-3">
                        <div class="card-body">
                            <h5 class="card-title">${booking.listing.title}</h5>
                            <div class="booking-details">
                                <p><strong>Check-in:</strong> ${booking.checkIn}</p>
                                <p><strong>Check-out:</strong> ${booking.checkOut}</p>
                                <p><strong>Guests:</strong> ${booking.guests}</p>
                                <p><strong>Total Amount:</strong> ₹${booking.totalAmount.toLocaleString("en-IN")}</p>
                                <p><strong>Status:</strong> <span class="badge bg-success">Confirmed</span></p>
                            </div>
                            <a href="/listings/${booking.listing._id}" class="btn btn-sm add-btn">View Property</a>
                            <button class="btn btn-sm btn-danger" onclick="cancelBooking('${booking._id}')">Cancel Booking</button>
                        </div>
                    </div>
                `;
            });
            bookingsContainer.innerHTML = bookingsHTML;
        }
    }
</script> 