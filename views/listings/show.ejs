<% layout('./layouts/boilerplate') %>
<style>
    /* Enhanced date picker styling */
    .form-control[type="date"] {
        position: relative;
        cursor: pointer;
        background-color: #fff;
        border: 2px solid #e9ecef;
        border-radius: 8px;
        padding: 12px 16px;
        font-size: 16px;
        transition: all 0.3s ease;
    }
    
    .form-control[type="date"]:focus {
        border-color: #007bff;
        box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
        outline: none;
    }
    
    .form-control[type="date"]:hover {
        border-color: #007bff;
    }
    
    /* Custom date picker icon */
    .form-control[type="date"]::-webkit-calendar-picker-indicator {
        background: transparent;
        bottom: 0;
        color: transparent;
        cursor: pointer;
        height: auto;
        left: 0;
        position: absolute;
        right: 0;
        top: 0;
        width: auto;
    }
    
    /* Date picker container */
    .date-input-container {
        position: relative;
    }
    
    .date-input-container::after {
        content: "ðŸ“…";
        position: absolute;
        right: 12px;
        top: 50%;
        transform: translateY(-50%);
        pointer-events: none;
        font-size: 18px;
    }
    
    /* Booking form enhancements */
    .booking-card {
        border: none;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        border-radius: 12px;
    }
    
    .booking-card .card-body {
        padding: 24px;
    }
    
    .form-label {
        font-weight: 600;
        color: #495057;
        margin-bottom: 8px;
    }
    
    .btn.add-btn {
        background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
        border: none;
        border-radius: 8px;
        padding: 12px 24px;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        transition: all 0.3s ease;
    }
    
    .btn.add-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 123, 255, 0.3);
    }
    
    /* Price breakdown styling */
    .price-breakdown {
        background: #f8f9fa;
        border-radius: 8px;
        padding: 16px;
        margin-bottom: 20px;
        border: 1px solid #e9ecef;
    }
    
    .breakdown-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 8px 0;
        font-size: 14px;
    }
    
    .breakdown-item.total {
        font-size: 16px;
        padding-top: 12px;
        border-top: 2px solid #dee2e6;
        margin-top: 8px;
    }
    
    .breakdown-item.total strong {
        color: #007bff;
    }
    
    .breakdown-item:not(.total) {
        color: #6c757d;
    }
    
    .breakdown-item:not(.total):hover {
        background: rgba(0, 123, 255, 0.05);
        border-radius: 4px;
        padding-left: 8px;
        padding-right: 8px;
    }
</style>
<body>
    <div class="row mt-5">
        <div class="card listing-card col-6 offset-2 show-card">
            <h4 class="card-text"><b><%= listing.title %></b></h4>
            
            <% if (listing.images && listing.images.length > 0) { %>
                <div id="listingCarousel" class="carousel slide" data-bs-ride="carousel">
                    <div class="carousel-inner" style="height: 50vh;">
                        <% listing.images.forEach((image, index) => { %>
                            <div class="carousel-item <%= index === 0 ? 'active' : '' %>">
                                <img src="<%= image %>" class="d-block w-100 show-img" alt="listing image <%= index + 1 %>" style="height: 50vh; object-fit: cover;">
                            </div>
                        <% }) %>
                    </div>
                    <% if (listing.images.length > 1) { %>
                        <button class="carousel-control-prev" type="button" data-bs-target="#listingCarousel" data-bs-slide="prev">
                            <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                            <span class="visually-hidden">Previous</span>
                        </button>
                        <button class="carousel-control-next" type="button" data-bs-target="#listingCarousel" data-bs-slide="next">
                            <span class="carousel-control-next-icon" aria-hidden="true"></span>
                            <span class="visually-hidden">Next</span>
                        </button>
                    <% } %>
                </div>
            <% } %>

            <div class="card-body">
                <i>Owned by <%= listing.owner.username %></i><br>
                <p class="card-text"><%= listing.description %><br><br>
                    <b>Price</b> â‚¹<%= listing.price.toLocaleString("en-IN") %> (including 5% admin fee)<br>
                    <% if (offer) { %>
                        <p>Current Offer: <%= offer.description %> - <%= offer.discountPercentage %>% off</p>
                        <p>Discounted Price: â‚¹<%= finalPrice.toLocaleString("en-IN") %></p>
                    <% } %>
                    <b>Location:</b> <%= listing.location %>, <%= listing.country %>
                </p>

                <% if (currentUser && (currentUser._id.toString() === listing.owner._id.toString() || currentUser.username === "TravelNest")) { %>
                    <div class="btns d-flex gap-2 mt-3">
                        <form method="get" action="/listings/<%= listing._id %>/edit">
                            <button type="submit" class="btn add-btn">Edit</button>
                        </form>
                        <form method="POST" action="/listings/<%= listing._id %>?_method=DELETE">
                            <button type="submit" class="btn btn-danger">Delete</button>
                        </form>
                    </div>
                <% } %>
            </div>
        </div>

        <% if (currentUser) { %>
            <% if (currentUser._id.toString() !== listing.owner._id.toString()) { %>
                <div class="col-md-3">
                    <div class="card shadow-sm booking-card">
                        <div class="card-body">
                            <h5 class="card-title mb-4">
                                <span id="basePrice">â‚¹<%= listing.price.toLocaleString("en-IN") %></span>
                                <span class="text-muted">/night</span>
                            </h5>
                            
                            <!-- Price breakdown -->
                            <div id="priceBreakdown" class="price-breakdown" style="display: none;">
                                <div class="breakdown-item">
                                    <span>Base price (<span id="nightsCount">0</span> nights Ã— â‚¹<%= listing.price.toLocaleString("en-IN") %>)</span>
                                    <span id="baseTotal">â‚¹0</span>
                                </div>
                                <div class="breakdown-item">
                                    <span>Guests (<span id="guestsCount">0</span> guests)</span>
                                    <span id="guestsFee">â‚¹0</span>
                                </div>
                                <div class="breakdown-item">
                                    <span>Admin fee (5%)</span>
                                    <span id="adminFee">â‚¹0</span>
                                </div>
                                <hr>
                                <div class="breakdown-item total">
                                    <strong>Total</strong>
                                    <strong id="totalPrice">â‚¹0</strong>
                                </div>
                            </div>
                            <form action="/payment/create/<%= listing._id %>" method="GET" id="bookingForm">
                                <div class="mb-3">
                                    <label class="form-label">Check-in Date</label>
                                    <div class="date-input-container">
                                        <input type="date" class="form-control" name="checkIn" id="checkInDate" required 
                                               min="<%= new Date().toISOString().split('T')[0] %>">
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Check-out Date</label>
                                    <div class="date-input-container">
                                        <input type="date" class="form-control" name="checkOut" id="checkOutDate" required
                                               min="<%= new Date().toISOString().split('T')[0] %>">
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Guests</label>
                                    <select class="form-control" name="guests" required>
                                        <option value="1">1 guest</option>
                                        <option value="2">2 guests</option>
                                        <option value="3">3 guests</option>
                                        <option value="4">4 guests</option>
                                        <option value="5">5 guests</option>
                                    </select>
                                </div>
                                <button type="submit" class="btn add-btn w-100">Book Now</button>
                            </form>
                            
                            <script>
                                // Enhanced date picker functionality with dynamic pricing
                                document.addEventListener('DOMContentLoaded', function() {
                                    const checkInDate = document.getElementById('checkInDate');
                                    const checkOutDate = document.getElementById('checkOutDate');
                                    const guestsSelect = document.querySelector('select[name="guests"]');
                                    const priceBreakdown = document.getElementById('priceBreakdown');
                                    
                                    // Base price from server
                                    const basePricePerNight = <%= listing.price %>;
                                    
                                    // Set minimum date to today
                                    const today = new Date().toISOString().split('T')[0];
                                    checkInDate.min = today;
                                    checkOutDate.min = today;
                                    
                                    // Function to calculate and display price
                                    function calculatePrice() {
                                        const checkIn = new Date(checkInDate.value);
                                        const checkOut = new Date(checkOutDate.value);
                                        const guests = parseInt(guestsSelect.value) || 1;
                                        
                                        if (!checkInDate.value || !checkOutDate.value || checkOut <= checkIn) {
                                            priceBreakdown.style.display = 'none';
                                            return;
                                        }
                                        
                                        // Calculate nights
                                        const nights = Math.ceil((checkOut - checkIn) / (1000 * 60 * 60 * 24));
                                        
                                        if (nights <= 0) {
                                            priceBreakdown.style.display = 'none';
                                            return;
                                        }
                                        
                                        // Calculate costs
                                        const baseTotal = basePricePerNight * nights;
                                        const guestsFee = guests > 2 ? (guests - 2) * 500 * nights : 0; // â‚¹500 per extra guest per night
                                        const subtotal = baseTotal + guestsFee;
                                        const adminFee = Math.round(subtotal * 0.05); // 5% admin fee
                                        const total = subtotal + adminFee;
                                        
                                        // Update display
                                        document.getElementById('nightsCount').textContent = nights;
                                        document.getElementById('guestsCount').textContent = guests;
                                        document.getElementById('baseTotal').textContent = 'â‚¹' + baseTotal.toLocaleString('en-IN');
                                        document.getElementById('guestsFee').textContent = 'â‚¹' + guestsFee.toLocaleString('en-IN');
                                        document.getElementById('adminFee').textContent = 'â‚¹' + adminFee.toLocaleString('en-IN');
                                        document.getElementById('totalPrice').textContent = 'â‚¹' + total.toLocaleString('en-IN');
                                        
                                        // Show price breakdown
                                        priceBreakdown.style.display = 'block';
                                        
                                        // Update button text
                                        const submitBtn = document.querySelector('.btn.add-btn');
                                        submitBtn.textContent = `Book Now - â‚¹${total.toLocaleString('en-IN')}`;
                                    }
                                    
                                    // Update check-out minimum date when check-in changes
                                    checkInDate.addEventListener('change', function() {
                                        const selectedCheckIn = new Date(this.value);
                                        const nextDay = new Date(selectedCheckIn);
                                        nextDay.setDate(nextDay.getDate() + 1);
                                        
                                        checkOutDate.min = nextDay.toISOString().split('T')[0];
                                        
                                        // If check-out is before new minimum, clear it
                                        if (checkOutDate.value && new Date(checkOutDate.value) <= selectedCheckIn) {
                                            checkOutDate.value = '';
                                        }
                                        
                                        calculatePrice();
                                    });
                                    
                                    // Validate check-out is after check-in
                                    checkOutDate.addEventListener('change', function() {
                                        const checkIn = new Date(checkInDate.value);
                                        const checkOut = new Date(this.value);
                                        
                                        if (checkOut <= checkIn) {
                                            alert('Check-out date must be after check-in date');
                                            this.value = '';
                                            calculatePrice();
                                            return;
                                        }
                                        
                                        calculatePrice();
                                    });
                                    
                                    // Update price when guests change
                                    guestsSelect.addEventListener('change', calculatePrice);
                                    
                                    // Form validation
                                    document.getElementById('bookingForm').addEventListener('submit', function(e) {
                                        const checkIn = new Date(checkInDate.value);
                                        const checkOut = new Date(checkOutDate.value);
                                        
                                        if (checkOut <= checkIn) {
                                            e.preventDefault();
                                            alert('Please select a valid check-out date after check-in date');
                                            return false;
                                        }
                                        
                                        // Calculate nights for user feedback
                                        const nights = Math.ceil((checkOut - checkIn) / (1000 * 60 * 60 * 24));
                                        if (nights > 0) {
                                            console.log(`Booking for ${nights} night(s)`);
                                        }
                                    });
                                });
                            </script>
                        </div>
                    </div>
                </div>
            <% } %>
        <% } else { %>
            <div class="col-md-3">
                <div class="card shadow-sm booking-card">
                    <div class="card-body">
                        <h5 class="card-title mb-4">â‚¹<%= listing.price.toLocaleString("en-IN") %> <span class="text-muted">/night</span></h5>
                        <p class="text-center mb-3">Please <a href="/login">login</a> to book this property</p>
                    </div>
                </div>
            </div>
        <% } %>

        <% if (currentUser) { %>
            <div class="col-8 offset-2 mb-3">
                <hr>
                <h5>Leave a Review</h5>
                <form method="POST" action="/listings/<%= listing._id %>/reviews" novalidate class="needs-validation">
                    <div class="mb-3 mt-2">
                        <label for="rating" class="form-label">Rating</label>
                        <fieldset class="starability-slot">
                            <input type="radio" id="no-rate" class="input-no-rate" name="rating" value="1" checked aria-label="No rating." />
                            <input type="radio" id="first-rate1" name="rating" value="1" />
                            <label for="first-rate1" title="Terrible">1 star</label>
                            <input type="radio" id="first-rate2" name="rating" value="2" />
                            <label for="first-rate2" title="Not good">2 stars</label>
                            <input type="radio" id="first-rate3" name="rating" value="3" />
                            <label for="first-rate3" title="Average">3 stars</label>
                            <input type="radio" id="first-rate4" name="rating" value="4" />
                            <label for="first-rate4" title="Very good">4 stars</label>
                            <input type="radio" id="first-rate5" name="rating" value="5" />
                            <label for="first-rate5" title="Amazing">5 stars</label>
                        </fieldset>
                    </div>
                    <div class="mb-3 mt-2">
                        <label for="review">Comment</label>
                        <textarea class="form-control" id="comment" name="comment" rows="3" required></textarea>
                        <div class="invalid-feedback">
                            Please add some comments for review.
                        </div>
                    </div>
                    <button type="submit" class="btn btn-outline-dark mt-2">Submit</button>
                </form>
                <hr>
            </div>
        <% } %>

        <div class="col-8 offset-2 mb-3">
            <h5>Reviews</h5>
            <div id="reviews" class="row">
                <% for (const review of listing.reviews) { %>
                    <div class="card col-5 ms-3 mb-2">
                        <div class="card-body">
                            <h5 class="card-title"><%= review.author.username %></h5>
                            <p class="starability-result" data-rating="<%= review.rating %>"></p>
                            <p class="card-text"><%= review.comment %></p>
                        </div>
                        <% if(currentUser && currentUser.id == review.author._id) { %>
                            <form class="mb-2" method="POST" action="/listings/<%= listing._id %>/reviews/<%= review._id %>?_method=DELETE">
                                <button type="submit" class="btn btn-dark">Delete</button>
                            </form>
                        <% } %>
                    </div>
                <% } %>
            </div>
        </div>
    </div>

    <script>
        // Remove the old date validation script since we're using manual input
    </script>
</body>
