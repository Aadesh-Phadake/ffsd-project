<%- layout('./layouts/boilerplate') %>

<link rel="stylesheet" href="/css/admin.css">

<div class="admin-wrapper">
  <!-- Sidebar -->
  <div class="admin-sidebar" id="adminSidebar">
    <div class="sidebar-header">
      <h3><i class="fas fa-tachometer-alt me-2"></i>Admin Panel</h3>
    </div>
    <nav class="sidebar-nav">
      <div class="nav-item">
        <a href="/admin" class="nav-link" data-page="dashboard">
          <i class="fas fa-chart-pie"></i>
          <span>Dashboard</span>
        </a>
      </div>
      <div class="nav-item">
        <a href="/admin/hotels" class="nav-link" data-page="hotels">
          <i class="fas fa-hotel"></i>
          <span>Hotel Management</span>
        </a>
      </div>
      <div class="nav-item">
        <a href="/admin/users" class="nav-link" data-page="users">
          <i class="fas fa-users"></i>
          <span>User Management</span>
        </a>
      </div>
      <div class="nav-item">
        <a href="/admin/messages" class="nav-link active" data-page="messages">
          <i class="fas fa-envelope"></i>
          <span>Messages</span>
          <% if (unreadCount > 0) { %>
            <span class="badge bg-danger ms-2"><%= unreadCount %></span>
          <% } %>
        </a>
      </div>
      <div class="nav-item">
        <a href="/listings" class="nav-link">
          <i class="fas fa-home"></i>
          <span>Back to Home</span>
        </a>
      </div>
      <div class="nav-item" style="margin-top: 2rem; border-top: 1px solid rgba(255,255,255,0.1); padding-top: 1rem;">
        <a href="/logout" class="nav-link">
          <i class="fas fa-sign-out-alt"></i>
          <span>Logout</span>
        </a>
      </div>
    </nav>
  </div>

  <!-- Main Content -->
  <div class="admin-content" id="adminContent">
    <div class="admin-page py-4">
      <div class="admin-header d-flex align-items-center justify-content-between mb-4">
        <div>
          <h1 class="h3 mb-1">Contact Messages</h1>
          <p class="text-muted mb-0">Manage customer inquiries and support requests</p>
        </div>
        <div class="d-flex gap-2">
          <span class="badge bg-primary"><%= messages.length %> Total</span>
          <% if (unreadCount > 0) { %>
            <span class="badge bg-warning"><%= unreadCount %> Unread</span>
          <% } %>
        </div>
      </div>

      <div class="management-table">
        <div class="table-responsive">
          <table class="table mb-0 align-middle">
            <thead>
              <tr>
                <th scope="col">Date</th>
                <th scope="col">Contact Info</th>
                <th scope="col">Subject</th>
                <th scope="col">Message</th>
                <th scope="col">Status</th>
                <th scope="col">Actions</th>
              </tr>
            </thead>
            <tbody>
              <% if (messages && messages.length > 0) { %>
                <% messages.forEach(message => { %>
                  <tr class="<%= (message.status === 'unread' || message.status === null) ? 'table-warning' : '' %>">
                    <td>
                      <div>
                        <div class="fw-semibold"><%= message.createdAt.toLocaleDateString('en-GB') %></div>
                        <small class="text-muted">
                          <%= message.createdAt.toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit' }) %>
                        </small>
                      </div>
                    </td>
                    <td>
                      <div>
                        <div class="fw-semibold"><%= message.name %></div>
                        <small class="text-muted"><%= message.email %></small>
                      </div>
                    </td>
                    <td>
                      <div class="fw-medium">
                        <%= (message.subject && message.subject.length > 30) ? message.subject.substring(0, 30) + '...' : (message.subject || 'No subject') %>
                      </div>
                    </td>
                    <td>
                      <div class="message-preview">
                        <%= message.message.length > 50 ? message.message.substring(0, 50) + '...' : message.message %>
                      </div>
                    </td>
                    <td>
                      <% if (message.status === 'unread' || message.status === null) { %>
                        <span class="badge bg-warning">Unread</span>
                      <% } else if (message.status === 'read') { %>
                        <span class="badge bg-info">Read</span>
                      <% } else { %>
                        <span class="badge bg-success">Replied</span>
                      <% } %>
                    </td>
                    <td>
                      <div class="action-buttons">
                        <button class="btn btn-view btn-action" 
                                onclick="viewMessage('<%= message._id %>', '<%= message.name %>', '<%= message.email %>', '<%= message.subject %>', `<%= message.message.replace(/`/g, '\\`').replace(/\n/g, '\\n') %>`, '<%= message.status %>')">
                          <i class="fas fa-eye"></i>
                        </button>
                        <% if (message.status === 'unread' || message.status === null) { %>
                          <button class="btn btn-edit btn-action" 
                                  onclick="markAsRead('<%= message._id %>')">
                            <i class="fas fa-check"></i>
                          </button>
                        <% } %>
                        <form method="POST" action="/admin/messages/<%= message._id %>?_method=DELETE" style="display: inline;">
                          <button type="submit" class="btn btn-delete btn-action" 
                                  onclick="return confirm('Are you sure you want to delete this message?')">
                            <i class="fas fa-trash"></i>
                          </button>
                        </form>
                      </div>
                    </td>
                  </tr>
                <% }) %>
              <% } else { %>
                <tr>
                  <td colspan="6" class="text-center text-muted py-4">
                    <i class="fas fa-envelope fa-3x mb-3 d-block text-muted opacity-50"></i>
                    <h5>No messages found</h5>
                    <p>No contact messages have been received yet.</p>
                  </td>
                </tr>
              <% } %>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Message Details Modal -->
<div class="modal fade" id="messageModal" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Message Details</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <div class="row">
          <div class="col-md-6">
            <strong>Name:</strong>
            <p id="modalName"></p>
          </div>
          <div class="col-md-6">
            <strong>Email:</strong>
            <p id="modalEmail"></p>
          </div>
          <div class="col-12">
            <strong>Subject:</strong>
            <p id="modalSubject"></p>
          </div>
          <div class="col-12">
            <strong>Message:</strong>
            <div id="modalMessage" class="p-3 border rounded bg-light"></div>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        <a href="" id="replyEmailBtn" class="btn btn-primary">
          <i class="fas fa-reply me-2"></i>Reply via Email
        </a>
      </div>
    </div>
  </div>
</div>

<style>
.message-preview {
  max-width: 200px;
  word-wrap: break-word;
}

.action-buttons {
  display: flex;
  gap: 5px;
  align-items: center;
}

.btn-action {
  width: 32px;
  height: 32px;
  padding: 0;
  border-radius: 6px;
  display: inline-flex;
  align-items: center;
  justify-content: center;
  font-size: 14px;
}

.btn-view {
  background-color: #0d6efd;
  color: white;
  border: 1px solid #0d6efd;
}

.btn-edit {
  background-color: #198754;
  color: white;
  border: 1px solid #198754;
}

.btn-delete {
  background-color: #dc3545;
  color: white;
  border: 1px solid #dc3545;
}

.table-warning {
  --bs-table-bg: #fff3cd;
}
</style>

<script>
function viewMessage(id, name, email, subject, message, status) {
  document.getElementById('modalName').textContent = name;
  document.getElementById('modalEmail').textContent = email;
  document.getElementById('modalSubject').textContent = subject;
  document.getElementById('modalMessage').textContent = message;
  
  // Set up reply email link
  const replySubject = 'Re: ' + subject;
  const replyBody = '\n\n--- Original Message ---\nFrom: ' + name + ' <' + email + '>\nSubject: ' + subject + '\n\n' + message;
  document.getElementById('replyEmailBtn').href = 
    'mailto:' + email + '?subject=' + encodeURIComponent(replySubject) + '&body=' + encodeURIComponent(replyBody);
  
  const modal = new bootstrap.Modal(document.getElementById('messageModal'));
  modal.show();
  
  // Mark as read if it's unread
  if (status === 'unread' || status === null) {
    markAsRead(id);
  }
}

async function markAsRead(messageId) {
  try {
    const response = await fetch(`/admin/messages/${messageId}/read`, {
      method: 'PATCH',
      headers: {
        'Content-Type': 'application/json'
      }
    });
    
    if (response.ok) {
      location.reload(); // Refresh to update the UI
    }
  } catch (error) {
    console.error('Error marking message as read:', error);
  }
}
</script>